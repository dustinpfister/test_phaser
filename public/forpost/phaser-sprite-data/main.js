
var Blocks = {};

Blocks.setup = function (game) {

    // create a data object for game if it is not there
    game.data = game.data || {};

    // create or overwrite game.data.blocks
    game.data.blocks = {
        group: game.add.group()
    };

};

Blocks.newSpriteDataObject = function (options) {

    return {
        dx: options.dx === undefined ? 0 : options.dx,
        dy: options.dy === undefined ? 0 : options.dy
    };

};

// make a sprite sheet
Blocks.mkSheet = function (game) {

    // sprite sheet generated by canvas
    var canvas = document.createElement('canvas'),
    ctx = canvas.getContext('2d');
    canvas.width = 64;
    canvas.height = 32;

    // blue frame
    ctx.fillStyle = '#0000ff';
    ctx.fillRect(0, 0, 32, 32);

    // red frame
    ctx.fillStyle = '#ff0000';
    ctx.fillRect(32, 0, 32, 32);

    game.cache.addSpriteSheet('sheet-block', null, canvas, 32, 32, 2, 0, 0);

};

Blocks.createSprite = function (game, options) {

    options = options || {};
    options.x = options.x === undefined ? 0 : options.x;
    options.y = options.y === undefined ? 0 : options.y;

    var sprite = game.data.blocks.group.create(options.x, options.y, 'sheet-block');

    sprite.data = Blocks.newSpriteDataObject(options);

};

var game = new Phaser.Game(320, 240, Phaser.AUTO, 'gamearea');

game.state.add('boot', {

    create: function () {

        Blocks.setup(game);

        Blocks.mkSheet(game);

        game.state.start('basic', false, false);

    }

});

game.state.add('basic', {

    create: function () {

        var sprite = game.add.sprite(0, 0, 'sheet-block');
        sprite.name = 'bx';

        sprite.data.frame = 0;
        sprite.data.frame_max = 50;
        sprite.data.sprite = sprite;
        sprite.data.game = game;

        // step sprite movement
        sprite.data.step = function () {

            this.per = this.frame / this.frame_max;
            this.bias = 1 - Math.abs(0.5 - this.per) / 0.5;

            this.sprite.x = this.game.world.centerX - 16 - 100 + 200 * this.bias;
            this.sprite.y = this.game.world.centerY - 16;

            this.frame += 1;
            this.frame %= this.frame_max;

        };

    },

    update: function () {

        var sprite = game.world.getByName('bx');

        sprite.data.step();

    }

});

game.state.add('demo', {

    create: function () {

        Blocks.createSprite(game, {
            x: 32,
            y: 32,
            dy: 5
        });

        Blocks.createSprite(game, {
            x: 32,
            y: 32,
            dx: 5
        });

        Blocks.createSprite(game, {
            x: 32,
            y: 32,
            dx: 5,
            dy: 5
        });

    },

    update: function () {

        this.game.data.blocks.group.forEach(function (block) {

            block.x = Phaser.Math.wrap(block.x += block.data.dx, -32, game.world.width + 32);
            block.y = Phaser.Math.wrap(block.y += block.data.dy, -32, game.world.height + 32);

        });

    }

});

game.state.start('boot');
